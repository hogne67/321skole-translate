rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ============================
       Helpers (null-safe)
    ============================ */
    function signedIn() {
      return request.auth != null;
    }

    function myUid() {
      return request.auth.uid;
    }

    // Firebase anonymous auth?
    function isAnonAuth() {
      return signedIn()
        && ("firebase" in request.auth.token)
        && ("sign_in_provider" in request.auth.token.firebase)
        && request.auth.token.firebase.sign_in_provider == "anonymous";
    }

    // --- Null-safe user lookup ---
    function myUserPath() {
      return /databases/$(database)/documents/users/$(myUid());
    }

    function myUserExists() {
      return signedIn() && exists(myUserPath());
    }

    // Returnerer {} hvis user-doc ikke finnes (så rules ikke krasjer)
    function myUser() {
      return myUserExists() ? get(myUserPath()).data : {};
    }

    // ---- Safe helpers for maps/keys ----
    function isMap(x) {
      return x is map;
    }

    // true bare hvis m er map, key finnes, og verdien er true
    function mapHasTrue(m, key) {
      return isMap(m) && (key in m) && m[key] == true;
    }

    function hasRole(roleName) {
      return mapHasTrue(myUser().roles, roleName);
    }

    function isAdmin() {
      return signedIn() && hasRole("admin");
    }

    function isApprovedTeacher() {
      return signedIn()
        && hasRole("teacher")
        && ("teacherStatus" in myUser())
        && myUser().teacherStatus == "approved";
    }

    /* ============================
       USERS
       /users/{uid}
    ============================ */
    match /users/{uid} {

      function isSelf() {
        return signedIn() && myUid() == uid;
      }

      // changedKeys() kan bare brukes på update (resource finnes da)
      function changedKeys() {
        return request.resource.data.diff(resource.data).changedKeys();
      }

      function isChanging(field) {
        return changedKeys().hasAny([field]);
      }

      // Self-update: ikke tillat endring av roles
      function rolesNotChangedBySelf() {
        return !isChanging("roles");
      }

      // Null-safe: hent eksisterende teacherStatus (default "none" hvis mangler)
      function currentTeacherStatus() {
        return ("teacherStatus" in resource.data) ? resource.data.teacherStatus : "none";
      }

      // Self-update: teacherStatus OK hvis:
      // - teacherStatus ikke endres
      // - ELLER settes til "pending" fra "none" eller "rejected"
      function teacherStatusSelfOk() {
        return !isChanging("teacherStatus")
          || (
            request.resource.data.teacherStatus == "pending"
            && (currentTeacherStatus() == "none" || currentTeacherStatus() == "rejected")
          );
      }

      // Create: ny bruker kan lage sin doc
      allow create: if isSelf();

      // Read: self + admin
      allow read: if isSelf() || isAdmin();

      // Update: admin kan alt. Self kan oppdatere alt unntatt roles, og teacherStatus iht regel.
      allow update: if isAdmin()
        || (isSelf() && rolesNotChangedBySelf() && teacherStatusSelfOk());

      allow delete: if false;
    }

    /* ============================
       LESSONS (draft)
       /lessons/{lessonId}
    ============================ */
    match /lessons/{lessonId} {
      allow read: if (signedIn() && resource != null && resource.data.ownerId == myUid()) || isAdmin();

      allow create: if signedIn()
        && request.resource.data.ownerId == myUid();

      allow update: if (signedIn() && resource != null && resource.data.ownerId == myUid()) || isAdmin();

      allow delete: if isAdmin();
    }

    /* ============================
       PUBLISHED LESSONS
       /published_lessons/{id}
    ============================ */
    match /published_lessons/{id} {
      allow read: if (resource != null && resource.data.isActive == true) || isAdmin();
      allow write: if false;
    }

    /* ============================
       SPACES (Teacher Space)
       /spaces/{spaceId}
    ============================ */
    match /spaces/{spaceId} {

      // Public read (metadata)
      allow read: if true;

      // Create: kun godkjent teacher, ownerId må være egen uid
      allow create: if isApprovedTeacher()
        && request.resource.data.ownerId == myUid()
        && request.resource.data.title is string
        && request.resource.data.code is string
        && request.resource.data.isOpen is bool;

      // Update/delete: bare eier eller admin
      allow update, delete: if isAdmin()
        || (signedIn() && resource != null && resource.data.ownerId == myUid());

      // (Valgfritt) space-level lessons docs:
      match /lessons/{lessonId} {
        allow read: if true;

        allow create, update, delete: if isAdmin()
          || (
            signedIn()
            && get(/databases/$(database)/documents/spaces/$(spaceId)).data.ownerId == myUid()
          );
      }

      // Submissions under space+lesson
      match /lessons/{lessonId}/submissions/{subId} {

  // ✅ Stabil path helper
  function spacePath() {
    return /databases/$(database)/documents/spaces/$(spaceId);
  }

  // ✅ Stabilt: exists() + get() (ikke .exists() på get-resultat)
  function spaceIsOpen() {
    return exists(spacePath()) && get(spacePath()).data.isOpen == true;
  }

  function isSpaceOwner() {
    return signedIn()
      && exists(spacePath())
      && get(spacePath()).data.ownerId == myUid();
  }


        // ✅ Modell A (bombesikker):
        // - HELT uinnlogget gjest: krever bare auth.isAnon == true
        // - Firebase anonymous auth: krever isAnon==true + uid==myUid()
        // - Vanlig innlogget: krever isAnon==false + uid==myUid()
        function validAuthOnCreate() {
          return (
            // 1) HELT uinnlogget gjest (request.auth == null)
            (!signedIn()
              && request.resource.data.auth is map
              && request.resource.data.auth.isAnon == true
            )
            ||
            // 2) Firebase anonymous auth (signInAnonymously)
            (isAnonAuth()
              && request.resource.data.auth is map
              && request.resource.data.auth.isAnon == true
              && request.resource.data.auth.uid == myUid()
            )
            ||
            // 3) Vanlig innlogget bruker
            (!isAnonAuth()
              && signedIn()
              && request.resource.data.auth is map
              && request.resource.data.auth.isAnon == false
              && request.resource.data.auth.uid == myUid()
            )
          );
        }

        allow create: if spaceIsOpen()
          && request.resource.data.spaceId == spaceId
          && request.resource.data.lessonId == lessonId
          && request.resource.data.status == "new"
          && !("teacherFeedback" in request.resource.data)
          && request.resource.data.auth is map
          && validAuthOnCreate();

        allow read: if isAdmin() || isSpaceOwner() || isOwnSubmission();

        // Update: bare lærer/admin, og de får kun endre feedback/status
        allow update: if isAdmin()
          || (
            isSpaceOwner()
            && resource != null
            && request.resource.data.spaceId == resource.data.spaceId
            && request.resource.data.lessonId == resource.data.lessonId
            && request.resource.data.createdAt == resource.data.createdAt
            && request.resource.data.answers == resource.data.answers
            && request.resource.data.auth == resource.data.auth
          );

        allow delete: if false;
      }
    }

    /* ============================
       SUBMISSIONS
       /submissions/{id}
       (brukes for “student submissions” uten space)
    ============================ */
    match /submissions/{id} {

      function isOwnSubmissionId() {
        return signedIn() && id.matches('^' + myUid() + '_');
      }

      function isOwnerDoc() {
        return signedIn() && resource != null && resource.data.uid == myUid();
      }

      allow create: if signedIn()
        && request.resource.data.uid == myUid();

      // read: admin eller eier
      allow read: if isAdmin()
        || (
          signedIn()
          && (
            (resource != null && resource.data.uid == myUid())
            || (resource == null && isOwnSubmissionId())
          )
        );

      allow update: if isAdmin()
        || (
          isOwnerDoc()
          && request.resource.data.uid == resource.data.uid
          && request.resource.data.publishedLessonId == resource.data.publishedLessonId
        );

      allow delete: if false;
    }

    /* ============================
       DEFAULT DENY
    ============================ */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
