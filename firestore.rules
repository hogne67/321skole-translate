rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ============================
       Helpers
    ============================ */
    function signedIn() {
      return request.auth != null;
    }

    function myUid() {
      return request.auth.uid;
    }

    function isAdmin() {
      return signedIn()
        && exists(/databases/$(database)/documents/users/$(myUid()))
        && get(/databases/$(database)/documents/users/$(myUid())).data.roles.admin == true;
    }

    /* ============================
       USERS
       /users/{uid}
    ============================ */
    match /users/{uid} {

      function isSelf() {
        return signedIn() && myUid() == uid;
      }

      function changedKeys() {
        return request.resource.data.diff(resource.data).changedKeys();
      }

      function isChanging(field) {
        return changedKeys().hasAny([field]);
      }

      function rolesNotChangedBySelf() {
        return !isChanging("roles");
      }

      function teacherStatusSelfOk() {
        return
          !isChanging("teacherStatus")
          || (
            request.resource.data.teacherStatus == "pending"
            && (resource.data.teacherStatus == "none" || resource.data.teacherStatus == "rejected")
          );
      }

      allow create: if isSelf()
        && (
          !request.resource.data.keys().hasAny(["roles"])
          || (
            request.resource.data.roles.student == true
            && request.resource.data.roles.admin != true
            && request.resource.data.roles.teacher != true
            && request.resource.data.roles.parent != true
          )
        );

      allow read: if isSelf() || isAdmin();

      allow update: if isAdmin()
        || (isSelf() && rolesNotChangedBySelf() && teacherStatusSelfOk());

      allow delete: if false;
    }

    /* ============================
       LESSONS (draft)
       /lessons/{lessonId}
    ============================ */
    match /lessons/{lessonId} {
      allow read: if (signedIn() && resource.data.ownerId == myUid()) || isAdmin();

      allow create: if signedIn()
        && request.resource.data.ownerId == myUid();

      allow update: if (signedIn() && resource.data.ownerId == myUid()) || isAdmin();

      allow delete: if isAdmin();
    }

    /* ============================
       PUBLISHED LESSONS
       /published_lessons/{id}
    ============================ */
    match /published_lessons/{id} {

      function docExists() {
        return exists(/databases/$(database)/documents/published_lessons/$(id));
      }

      // legacy-safe: hvis isActive mangler, behandles som true
      function isActiveOrMissing() {
        return !resource.data.keys().hasAny(["isActive"]) || resource.data.isActive == true;
      }

      // ✅ Viktig: sjekk exists først for å unngå permission-denied når doc mangler
      allow read: if !docExists() || isActiveOrMissing() || isAdmin();
      allow write: if false;
    }

    /* ============================
       SUBMISSIONS
       /submissions/{id}
       (for "gjøre oppgave")
    ============================ */
    match /submissions/{id} {

      function isOwner() {
        return signedIn() && resource.data.uid == myUid();
      }

      function isOwnerCreate() {
        return signedIn() && request.resource.data.uid == myUid();
      }

      allow create: if isOwnerCreate();
      allow read: if isOwner() || isAdmin();

      // ✅ Tillat at eier oppdaterer sin submission (typisk underveis lagring)
      allow update: if isOwner()
        && request.resource.data.uid == myUid();

      allow delete: if false;
    }

    /* ============================
       DEFAULT DENY
    ============================ */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
