rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ============================
       Helpers
    ============================ */
    function signedIn() {
      return request.auth != null;
    }

    function myUid() {
      return request.auth.uid;
    }

    function isAdmin() {
      return signedIn()
        && exists(/databases/$(database)/documents/users/$(myUid()))
        && get(/databases/$(database)/documents/users/$(myUid())).data.roles.admin == true;
    }

    /* ============================
       USERS
       /users/{uid}
    ============================ */
    match /users/{uid} {

      function isSelf() {
        return signedIn() && myUid() == uid;
      }

      function changedKeys() {
        return request.resource.data.diff(resource.data).changedKeys();
      }

      function isChanging(field) {
        return changedKeys().hasAny([field]);
      }

      function rolesNotChangedBySelf() {
        return !isChanging("roles");
      }

      function teacherStatusSelfOk() {
        return
          !isChanging("teacherStatus")
          || (
            request.resource.data.teacherStatus == "pending"
            && (resource.data.teacherStatus == "none" || resource.data.teacherStatus == "rejected")
          );
      }

      allow create: if isSelf()
        && (
          !request.resource.data.keys().hasAny(["roles"])
          || (
            request.resource.data.roles.student == true
            && request.resource.data.roles.admin != true
            && request.resource.data.roles.teacher != true
            && request.resource.data.roles.parent != true
          )
        );

      allow read: if isSelf() || isAdmin();

      allow update: if isAdmin()
        || (isSelf() && rolesNotChangedBySelf() && teacherStatusSelfOk());

      allow delete: if false;
    }

    /* ============================
       LESSONS (draft)
       /lessons/{lessonId}
    ============================ */
    match /lessons/{lessonId} {
      allow read: if (signedIn() && resource.data.ownerId == myUid()) || isAdmin();

      allow create: if signedIn()
        && request.resource.data.ownerId == myUid();

      allow update: if (signedIn() && resource.data.ownerId == myUid()) || isAdmin();

      allow delete: if isAdmin();
    }

    /* ============================
       PUBLISHED LESSONS
       /published_lessons/{id}
    ============================ */
    match /published_lessons/{id} {

      function isActiveOrMissing() {
        return !resource.data.keys().hasAny(["isActive"]) || resource.data.isActive == true;
      }

      allow read: if isActiveOrMissing() || isAdmin();
      allow write: if false;
    }

    /* ============================
       SUBMISSIONS
       /submissions/{id}
    ============================ */
    match /submissions/{id} {

      function isOwner() {
        return signedIn()
          && resource.data.uid == myUid();
      }

      // På create finnes ikke resource, så vi sjekker request.resource
      function isOwnerCreate() {
        return signedIn()
          && request.resource.data.uid == myUid();
      }

      // CREATE: eier kan opprette sin egen submission
      allow create: if isOwnerCreate();

      // READ: eier + admin
      allow read: if isOwner() || isAdmin();

      // UPDATE: eier kan oppdatere sin egen submission
      // (krever at uid ikke “byttes”)
      allow update: if isOwner()
        && request.resource.data.uid == myUid();

      // DELETE: valgfritt – jeg lar den være false (tryggest)
      allow delete: if false;
    }

    /* ============================
       DEFAULT DENY
    ============================ */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
