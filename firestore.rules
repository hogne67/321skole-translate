rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ============================
       Helpers
    ============================ */
    function signedIn() {
      return request.auth != null;
    }

    function myUid() {
      return request.auth.uid;
    }

    // NB: isAdmin() leser users/{myUid}. Det er OK, men m책 ikke brukes p책 en m책te
    // som blokkerer onboarding for nye brukere. Vi holder den enkel.
    function isAdmin() {
      return signedIn()
        && exists(/databases/$(database)/documents/users/$(myUid()))
        && get(/databases/$(database)/documents/users/$(myUid())).data.roles.admin == true;
    }

    /* ============================
       USERS
       /users/{uid}
    ============================ */
    match /users/{uid} {

  function isSelf() {
    return signedIn() && myUid() == uid;
  }

  // changedKeys() kan kun brukes p책 update (resource finnes).
  function changedKeys() {
    return request.resource.data.diff(resource.data).changedKeys();
  }

  function isChanging(field) {
    return changedKeys().hasAny([field]);
  }

  // Self-update: ikke tillat endring av roles
  function rolesNotChangedBySelf() {
    return !isChanging("roles");
  }

  // Self-update: teacherStatus OK hvis:
  // - teacherStatus ikke endres
  // - ELLER settes til "pending" fra "none" eller "rejected"
  function teacherStatusSelfOk() {
    return
      !isChanging("teacherStatus")
      || (
        request.resource.data.teacherStatus == "pending"
        && (resource.data.teacherStatus == "none" || resource.data.teacherStatus == "rejected")
      );
  }

  // Create: ny bruker kan lage sin doc.
  // Hvis roles finnes ved create, tillat kun student=true (ikke admin/teacher/parent)
  allow create: if isSelf()
    && (
      !request.resource.data.keys().hasAny(["roles"])
      || (
        request.resource.data.roles.student == true
        && request.resource.data.roles.admin != true
        && request.resource.data.roles.teacher != true
        && request.resource.data.roles.parent != true
      )
    );

  // Read: self + admin
  allow read: if isSelf() || isAdmin();

  // Update: self kan oppdatere alt unntatt roles, og teacherStatus iht regel.
  // admin kan oppdatere alt.
  allow update: if isAdmin()
    || (isSelf() && rolesNotChangedBySelf() && teacherStatusSelfOk());

  allow delete: if false;
}

    /* ============================
       LESSONS (draft)
       /lessons/{lessonId}
    ============================ */
    match /lessons/{lessonId} {

      // Viktig med parenteser (operator precedence)
      allow read: if (signedIn() && resource.data.ownerId == myUid()) || isAdmin();

      allow create: if signedIn()
        && request.resource.data.ownerId == myUid();

      allow update: if (signedIn() && resource.data.ownerId == myUid()) || isAdmin();

      allow delete: if isAdmin();
    }

    /* ============================
       PUBLISHED LESSONS
       /published_lessons/{id}
    ============================ */
    match /published_lessons/{id} {
      allow read: if resource.data.isActive == true || isAdmin();
      allow write: if false;
    }

    /* ============================
       SUBMISSIONS
       /submissions/{id}
    ============================ */
    match /submissions/{id} {

      allow create: if signedIn()
        && request.resource.data.uid == myUid();

      allow read: if (signedIn() && resource.data.uid == myUid()) || isAdmin();

      allow update: if false;
      allow delete: if false;
    }

    /* ============================
       DEFAULT DENY
    ============================ */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
